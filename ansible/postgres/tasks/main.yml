---
- name: Install PostgreSQL 15 packages
  ansible.builtin.dnf:
    name:
    - postgresql15-server
    - postgresql15-contrib
    - python3-psycopg2 
    state: present
  become: true

- name: Initialize PostgreSQL database cluster
  ansible.builtin.command:
    cmd: postgresql-setup --initdb
    creates: /var/lib/pgsql/data/postgresql.conf
  become: true

- name: Set correct permissions and ownership for PostgreSQL data directory
  ansible.builtin.file:
    path: /var/lib/pgsql/data
    owner: postgres
    group: postgres
    recurse: true
    state: directory
  become: true

- name: Set PostgreSQL to use MD5 password authentication for local connections (Robust Insert)
  ansible.builtin.lineinfile:
    path: /var/lib/pgsql/data/pg_hba.conf
    insertbefore: "^host\\s+all\\s+all\\s+127\\.0\\.0\\.1\\/32\\s+(ident|peer)$"
    line: 'host all all 127.0.0.1/32 md5'
    state: present
    backup: yes
  become: true
  notify: Restart PostgreSQL

- name: Enable and start PostgreSQL service
  ansible.builtin.service:
    name: postgresql
    state: started
    enabled: true
  become: true

# --- Database Configuration Tasks ---

- name: Create database user ({{ db_user }})
  ansible.builtin.postgresql_user:
    name: "{{ db_user }}"
    password: "{{ db_password }}"
    role_attr_flags: CREATEDB,LOGIN
  become: true
  become_user: postgres

- name: Copy init.sql to server
  ansible.builtin.copy:
    src: ../db/init.sql
    dest: /tmp/init.sql
    mode: '0644'
  become: true

- name: Run init.sql to populate the database
  ansible.builtin.shell: "psql -d postgres -f /tmp/init.sql"
  become: true
  become_user: postgres

... 